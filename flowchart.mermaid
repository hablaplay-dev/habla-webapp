flowchart LR

%% === Frontend ===
subgraph FE["Frontend - Habla Webapp (SPA)"]
  direction TB
  FE_Router["Router SPA / Navegacion"]
  FE_Login["Login / Signup (modal)"]
  FE_TopUp["Top Up Lukas (modal)"]
  FE_Create["Crear Ticket (5 predicciones)"]
  FE_Match["Match Detail / Transparency / Leaderboard"]
  FE_Store["Prize Store"]
  FE_Wallet["Wallet / Movements"]
  FE_Toast["Toasts / Notifs"]
end

%% === Event Bus ===
EB["Event Bus (Kafka o NATS)"]

%% === Auth ===
subgraph AUTH["Auth"]
  direction TB
  A_Signup["POST /auth/signup"]
  A_Login["POST /auth/login"]
  A_Token["Emitir JWT / Session"]
  A_Evt["Evento: User.Registered"]
end

%% === Perfil ===
subgraph PERFIL["Perfil"]
  direction TB
  P_Create["Crear perfil base"]
  P_History["GET /me/history?days=30"]
end

%% === Wallet ===
subgraph WALLET["Wallet"]
  direction TB
  W_Create["Crear Wallet"]
  W_Credit["POST /wallet/credit"]
  W_Debit["POST /wallet/debit (con idempotency_key)"]
  W_Mov["GET /wallet/movements"]
  W_evtC["Evento: Wallet.CreditPosted"]
  W_evtD["Evento: Wallet.DebitPosted"]
end

%% === Pagos ===
subgraph PAY["Pagos (On-Ramp)"]
  direction TB
  Pay_Start["POST /payments (inicia checkout PSP)"]
  Pay_Webhook["Webhook PSP (validar firma/estado)"]
  Pay_Settle["Asentar Lukas netas"]
  Pay_evtI["Evento: Payment.Initiated"]
  Pay_evtS["Evento: Payment.Settled"]
end

%% === Torneos y Partidos ===
subgraph TP["Torneos y Partidos"]
  direction TB
  T_Create["Crear partido/torneo (lock_time = kickoff)"]
  T_Lock["Match.StateChanged(en_juego)"]
  T_End["Match.StateChanged(terminado)"]
  T_Cancel["Match.StateChanged(cancelado)"]
end

%% === Reglas ===
subgraph RULES["Reglas y Puntajes"]
  direction TB
  R_Ruleset["Ruleset: 1X2=3, BTTS=2, O2.5=2, Roja=6, Exacto=8"]
end

%% === Combinadas ===
subgraph TICKETS["Combinadas (Tickets)"]
  direction TB
  C_Validate["Validar picks y dominio"]
  C_Uniq["Validar unicidad (user, match, hash)"]
  C_Debit["Solicitar debito fee a Wallet"]
  C_Save["Persistir ticket + hash"]
  C_Log["Log inmutable (hash/merkle)"]
  C_evt["Evento: Ticket.Submitted"]
end

%% === Oraculos de Datos ===
subgraph ORACLE["Oraculos de Datos"]
  direction TB
  O_Live["Ingesta live (goles, tarjetas)"]
  O_Final["MatchFacts.Finalized (FT score, BTTS, O2.5, Red, 1X2)"]
  O_Correct["MatchFacts.Corrected (v+1)"]
end

%% === Transparencia ===
subgraph TRANS["Transparencia"]
  direction TB
  TR_Append["Append tickets pre-kickoff (WORM)"]
  TR_Reveal["Revelar combinadas al kickoff"]
  TR_Merkle["Publicar Merkle Root"]
end

%% === Scoring ===
subgraph SCORE["Scoring"]
  direction TB
  S_Eval["Evaluar tickets vs hechos del partido"]
  S_evt["Evento: Scoring.Completed"]
end

%% === Leaderboard ===
subgraph LDB["Leaderboard"]
  direction TB
  L_Rank["Ranking y desempates (exacto -> timestamp -> prorrateo)"]
  L_evt["Evento: Leaderboard.Finalized"]
end

%% === Liquidacion ===
subgraph SETTLE["Liquidacion"]
  direction TB
  LI_Pool["Calcular Pozo (sum fees - rake)"]
  LI_Payouts["Abonar ganadores (Wallet credit)"]
  LI_Adjust["Ajustes por correcciones"]
  LI_evt["Evento: Payouts.Posted"]
end

%% === Tienda ===
subgraph STORE["Tienda de Premios"]
  direction TB
  ST_List["GET /store (stock, condiciones)"]
  ST_Redeem["POST /redeem (validar saldo/politicas)"]
  ST_Block["Reservar stock"]
  ST_evt["Evento: Reward.Redeemed"]
end

%% === Fulfillment ===
subgraph FULL["Fulfillment"]
  direction TB
  F_Digital["Emitir codigo (digital)"]
  F_Ship["Courier fisico: requested -> shipped -> delivered"]
  F_evt["Evento: Fulfillment.Completed"]
end

%% === Riesgo / Fraude ===
subgraph RISK["Riesgo / Fraude"]
  direction TB
  RISK_Checks["Velocity, IP/device, multi-cuenta, patrones"]
  RF_evt["Evento: Risk.Flagged"]
end

%% === Notificaciones ===
subgraph NOTIF["Notificaciones"]
  direction TB
  N_Send["Enviar plantilla email/push/in-app"]
end

%% === Auditoria ===
subgraph AUDIT["Auditoria y Logs"]
  direction TB
  AU_Log["Append-only de eventos"]
end


%% === 1) Registro / Login ===
FE_Login --> A_Login
A_Login --> A_Token
A_Login -.-> A_Evt
A_Evt -.-> EB
EB -.-> P_Create
EB -.-> W_Create
EB -.-> AU_Log
A_Token --> FE_Router

%% === 2) Top Up (Pagos -> Wallet) ===
FE_TopUp --> Pay_Start
Pay_Start -.-> Pay_evtI
Pay_evtI -.-> EB
EB -.-> AU_Log
Pay_Webhook --> Pay_Settle
Pay_Settle --> W_Credit
W_Credit -.-> W_evtC
W_evtC -.-> EB
EB -.-> N_Send
N_Send --> FE_Toast

%% === 3) Crear Torneo/Partido ===
T_Create --> R_Ruleset
T_Create -.-> EB
EB -.-> AU_Log

%% === 4) Envio de Combinada ===
FE_Create --> C_Validate
C_Validate --> C_Uniq
C_Uniq --> C_Debit
C_Debit --> W_Debit
W_Debit -.-> W_evtD
W_evtD -.-> EB
C_Debit --> C_Save
C_Save --> C_Log
C_Log --> TR_Append
C_Save -.-> C_evt
C_evt -.-> EB
EB -.-> AU_Log
EB -.-> RISK_Checks
RISK_Checks -.-> RF_evt
RF_evt -.-> EB

%% === 5) Kickoff -> Lock + Transparencia ===
T_Lock -.-> EB
EB -.-> TR_Reveal
TR_Reveal --> FE_Match
TR_Merkle --> FE_Match
EB -.-> AU_Log

%% === 6) Final del Partido -> Scoring -> Leaderboard -> Liquidacion ===
O_Final -.-> EB
EB -.-> S_Eval
S_Eval -.-> S_evt
S_evt -.-> EB
EB -.-> L_Rank
L_Rank -.-> L_evt
L_evt -.-> EB
EB -.-> LI_Pool
LI_Pool --> LI_Payouts
LI_Payouts --> W_Credit
W_Credit -.-> W_evtC
W_evtC -.-> EB
EB -.-> LI_evt
EB -.-> N_Send
N_Send --> FE_Toast
EB -.-> AU_Log

%% === 7) Correcciones post-partido (v+1) ===
O_Correct -.-> EB
EB -.-> S_Eval
S_Eval -.-> S_evt
S_evt -.-> EB
EB -.-> L_Rank
L_Rank -.-> L_evt
L_evt -.-> EB
EB -.-> LI_Adjust
LI_Adjust --> W_Credit
LI_Adjust --> W_Debit
W_Credit -.-> W_evtC
W_Debit -.-> W_evtD
W_evtC -.-> EB
W_evtD -.-> EB
EB -.-> N_Send
EB -.-> AU_Log

%% === 8) Cancelacion / Suspension ===
T_Cancel -.-> EB
EB -.-> LI_Adjust
LI_Adjust --> W_Credit
W_Credit -.-> W_evtC
EB -.-> N_Send
EB -.-> AU_Log

%% === 9) Store -> Redeem -> Fulfillment ===
FE_Store --> ST_List
FE_Store --> ST_Redeem
ST_Redeem --> ST_Block
ST_Redeem --> W_Debit
W_Debit -.-> W_evtD
ST_Redeem -.-> ST_evt
ST_evt -.-> EB
EB -.-> F_Digital
EB -.-> F_Ship
F_Digital -.-> F_evt
F_Ship -.-> F_evt
F_evt -.-> EB
EB -.-> N_Send
N_Send --> FE_Toast
EB -.-> AU_Log

%% === 10) Lecturas desde Frontend (GET) ===
FE_Router --> P_History
FE_Wallet --> W_Mov
FE_Match --> TR_Reveal
FE_Match --> L_Rank


%% ===================== STYLES =====================
classDef fe fill:#f8fafc,stroke:#94a3b8,stroke-width:1px,color:#111827;
classDef bus fill:#eef2ff,stroke:#6366f1,stroke-width:2px,color:#111827;
classDef evt fill:#ecfeff,stroke:#06b6d4,stroke-width:1px,color:#0e7490;

class FE_Router,FE_Login,FE_TopUp,FE_Create,FE_Match,FE_Store,FE_Wallet,FE_Toast fe;
class EB bus;
class A_Evt,W_evtC,W_evtD,Pay_evtI,Pay_evtS,C_evt,S_evt,L_evt,LI_evt,ST_evt,F_evt,RF_evt evt;
